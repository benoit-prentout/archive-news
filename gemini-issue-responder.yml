name: Gemini Issue Responder

# Le workflow se d√©clenche quand on ajoute un label √† une issue
on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write # N√©cessaire pour poster un commentaire

jobs:
  respond:
    # On ne lance le job que si le label est 'question-gemini'
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Call Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # On pr√©pare le JSON pour l'API Gemini (model: gemini-1.5-flash pour la rapidit√©)
          # On √©chappe les guillemets pour √©viter les erreurs JSON
          ESCAPED_BODY=$(echo "$ISSUE_BODY" | jq -Rsa .)
          ESCAPED_TITLE=$(echo "$ISSUE_TITLE" | jq -Rsa .)
          
          # Construction du prompt
          PROMPT="Tu es un expert technique assistant sur GitHub. Voici une issue intitul√©e $ESCAPED_TITLE. Contenu: $ESCAPED_BODY. Peux-tu proposer une solution ou une r√©ponse utile ?"
          
          # Appel API via cURL
          RESPONSE=$(curl -s \
            -H "Content-Type: application/json" \
            -d "{ \"contents\": [{ \"parts\": [{ \"text\": $PROMPT }] }] }" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY")
          
          # Extraction de la r√©ponse (texte) depuis le JSON retourn√© par Google
          ANSWER=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          # On sauvegarde la r√©ponse pour l'√©tape suivante (gestion multiligne s√©curis√©e)
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
        run: |
          # Utilisation de GitHub CLI (gh) pr√©install√© pour commenter
          gh issue comment "$ISSUE_NUMBER" --body "ü§ñ **R√©ponse de Gemini :**
          
          $AI_RESPONSE"
