<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAT photoweb</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="viewer-layout">
        <!-- Main Content -->
        <div class="viewer-main">
            <!-- Header -->
            <header class="viewer-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h1
                        style="font-family: var(--font-header); font-size: 1rem; font-weight: 600; margin: 0; max-width: 500px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--accent-blue);">
                        BAT photoweb
                    </h1>
                </div>

                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="viewer-toolbar">
                        <button class="btn btn-secondary" onclick="toggleHighlightLinks()"
                            title="Highlight all links (H)">
                            <span id="highlightBtnText">Show Links</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openHtmlModal()" title="View HTML (V)">
                            View HTML
                        </button>
                    </div>

                    <span class="crm-badge" data-crm="Unknown">Unknown</span>

                    <div class="device-toggle hide-mobile">
                        <button class="device-btn" onclick="setMode('mobile')" title="Mobile (1)">Mobile</button>
                        <button class="device-btn" onclick="setMode('tablet')" title="Tablet (2)">Tablet</button>
                        <button class="device-btn active" onclick="setMode('desktop')"
                            title="Desktop (3)">Desktop</button>
                    </div>

                    <button class="btn-icon" id="theme-toggle" onclick="toggleTheme()" title="Toggle Theme (T)">
                        <svg class="icon icon-moon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg class="icon icon-sun" style="display:none;" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Email Content -->
            <div class="viewer-content">
                <div id="deviceFrame" data-mode="desktop"
                    style="width: 100%; max-width: 800px; height: 100%; transition: max-width 0.3s ease;">
                    <iframe id="emailFrame" class="email-frame"></iframe>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="viewer-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Metadata</span>
            </div>

            <div class="sidebar-content">
                <!-- General Info -->
                <div class="meta-section">
                    <div class="meta-section-title">General</div>
                    <div class="meta-row">
                        <span class="meta-key">Sender</span>
                        <span class="meta-val">DEBARGE Victoire</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Subject</span>
                        <span class="meta-val"
                            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="BAT photoweb">BAT photoweb</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Preheader</span>
                        <span class="meta-val"
                            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="Bonjour Benoit, Voici le BAT pour l’email NE Photoweb Belle journée https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqr...">Bonjour Benoit, Voici le BAT pour l’email NE Photoweb Belle journée https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqr...</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Received</span>
                        <span class="meta-val">29/12/2025 à 12:44</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">CRM</span>
                        <span class="meta-val text-cyan" style="font-weight: 700;">Unknown</span>
                    </div>
                </div>

                <!-- Technical -->
                <div class="meta-section">
                    <div class="meta-section-title">Technical</div>
                    <div class="meta-row">
                        <span class="meta-key">Size</span>
                        <span class="meta-val text-yellow">6.0 KB</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Clipping Risk</span>
                        <span class="meta-val text-green"
                            style="font-weight: 700;">
                            Low
                        </span>
                    </div>
                </div>

                <!-- Tracking Pixels -->
                

                <!-- All Links -->
                <div class="meta-section" style="flex: 1;">
                    <div class="meta-section-title">Links (3)</div>
                    
                    <div class="link-card-v2" onclick="highlightLink(1)">
                        <div class="card-v2-header">
                            <span class="card-v2-index">1</span>
                            <span class="card-v2-domain">m12.news.laredoute.fr</span>
                            <div style="display: flex; gap: 4px;">
                                
                                
                                
                            </div>
                        </div>
                        <div class="card-v2-body">
                            <div class="card-v2-text">https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qU</div>
                            <div class="card-v2-url-zone">
                                <code class="card-v2-url">https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqrTJBsmCulFQ%2BZ200mv9SeR8Mx2J8KsqYP%2B4GRZH3kHQ%3D%3D</code>

                                <div
                                    style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; justify-content: flex-end;">
                                    <button class="btn-card" title="Verify Link"
                                        onclick="event.stopPropagation(); runAudit(this, 'https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqrTJBsmCulFQ%2BZ200mv9SeR8Mx2J8KsqYP%2B4GRZH3kHQ%3D%3D')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn-card" title="Copy URL"
                                        onclick="event.stopPropagation(); copyLink(this, 'https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqrTJBsmCulFQ%2BZ200mv9SeR8Mx2J8KsqYP%2B4GRZH3kHQ%3D%3D')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Audit Log Container -->
                            <div class="audit-log-container">
                                <div class="audit-status-bar">
                                    <span class="audit-status-text">Scanning...</span>
                                </div>
                                <div class="audit-timeline">
                                    <!-- Log items will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="link-card-v2" onclick="highlightLink(2)">
                        <div class="card-v2-header">
                            <span class="card-v2-index">2</span>
                            <span class="card-v2-domain">External Link</span>
                            <div style="display: flex; gap: 4px;">
                                
                                <span class="card-v2-tag tag-unsecure"><svg width="8"
                                        height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="3">
                                        <path
                                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                        <line x1="12" y1="9" x2="12" y2="13" />
                                        <line x1="12" y1="17" x2="12.01" y2="17" />
                                    </svg> HTTP</span>
                                
                            </div>
                        </div>
                        <div class="card-v2-body">
                            <div class="card-v2-text">vdebarge</div>
                            <div class="card-v2-url-zone">
                                <code class="card-v2-url">mailto:vdebarge@redoute.fr</code>

                                <div
                                    style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; justify-content: flex-end;">
                                    <button class="btn-card" title="Verify Link"
                                        onclick="event.stopPropagation(); runAudit(this, 'mailto:vdebarge@redoute.fr')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn-card" title="Copy URL"
                                        onclick="event.stopPropagation(); copyLink(this, 'mailto:vdebarge@redoute.fr')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Audit Log Container -->
                            <div class="audit-log-container">
                                <div class="audit-status-bar">
                                    <span class="audit-status-text">Scanning...</span>
                                </div>
                                <div class="audit-timeline">
                                    <!-- Log items will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="link-card-v2" onclick="highlightLink(3)">
                        <div class="card-v2-header">
                            <span class="card-v2-index">3</span>
                            <span class="card-v2-domain">External Link</span>
                            <div style="display: flex; gap: 4px;">
                                
                                <span class="card-v2-tag tag-unsecure"><svg width="8"
                                        height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="3">
                                        <path
                                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                        <line x1="12" y1="9" x2="12" y2="13" />
                                        <line x1="12" y1="17" x2="12.01" y2="17" />
                                    </svg> HTTP</span>
                                
                            </div>
                        </div>
                        <div class="card-v2-body">
                            <div class="card-v2-text">@redoute.fr</div>
                            <div class="card-v2-url-zone">
                                <code class="card-v2-url">mailto:vdebarge@redoute.fr</code>

                                <div
                                    style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; justify-content: flex-end;">
                                    <button class="btn-card" title="Verify Link"
                                        onclick="event.stopPropagation(); runAudit(this, 'mailto:vdebarge@redoute.fr')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </button>
                                    <button class="btn-card" title="Copy URL"
                                        onclick="event.stopPropagation(); copyLink(this, 'mailto:vdebarge@redoute.fr')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Audit Log Container -->
                            <div class="audit-log-container">
                                <div class="audit-status-bar">
                                    <span class="audit-status-text">Scanning...</span>
                                </div>
                                <div class="audit-timeline">
                                    <!-- Log items will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Sticky Footer in Sidebar -->
            <div class="sidebar-footer">
                <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin: 0;">
                    © 2025 <a href="https://github.com/benoit-prentout" target="_blank"
                        style="color: var(--accent-cyan); text-decoration: underline dotted; font-weight: 600;">Benoît
                        Prentout</a>.
                    All rights reserved.
                </p>
            </div>
        </aside>
    </div>

    <!-- HTML Source Modal -->
    <div class="modal-overlay" id="htmlModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" style="color: var(--accent-blue);">HTML Source</span>
                <button class="modal-close" onclick="closeHtmlModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre class="code-block" id="htmlSourceCode"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="copyAllHtml()">Copy HTML</button>
            </div>
        </div>
    </div>

    <!-- Link overlays container -->
    <div id="linkOverlays" style="position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100;"></div>

    <script src="../assets/js/main.js"></script>
    <script>
        const content = "<html xmlns=\"http://www.w3.org/TR/REC-html40\" xmlns:m=\"http://schemas.microsoft.com/office/2004/12/omml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\">\n<head>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<meta content=\"Microsoft Word 15 (filtered medium)\" name=\"Generator\"/>\n<!--[if !mso]><style>v\\:* {behavior:url(#default#VML);}\r\no\\:* {behavior:url(#default#VML);}\r\nw\\:* {behavior:url(#default#VML);}\r\n.shape {behavior:url(#default#VML);}\r\n</style><![endif]--><style><!--\r\n/* Font Definitions */\r\n@font-face\r\n\t{font-family:\"Cambria Math\";\r\n\tpanose-1:2 4 5 3 5 4 6 3 2 4;}\r\n@font-face\r\n\t{font-family:Aptos;}\r\n@font-face\r\n\t{font-family:Poppins;\r\n\tpanose-1:0 0 5 0 0 0 0 0 0 0;}\r\n/* Style Definitions */\r\np.MsoNormal, li.MsoNormal, div.MsoNormal\r\n\t{margin:0cm;\r\n\tfont-size:12.0pt;\r\n\tfont-family:\"Aptos\",sans-serif;\r\n\tmso-ligatures:standardcontextual;\r\n\tmso-fareast-language:EN-US;}\r\na:link, span.MsoHyperlink\r\n\t{mso-style-priority:99;\r\n\tcolor:#467886;\r\n\ttext-decoration:underline;}\r\na:visited, span.MsoHyperlinkFollowed\r\n\t{mso-style-priority:99;\r\n\tcolor:#96607D;\r\n\ttext-decoration:underline;}\r\nspan.EmailStyle17\r\n\t{mso-style-type:personal-compose;\r\n\tfont-family:\"Aptos\",sans-serif;\r\n\tcolor:windowtext;}\r\n.MsoChpDefault\r\n\t{mso-style-type:export-only;\r\n\tmso-fareast-language:EN-US;}\r\n@page WordSection1\r\n\t{size:612.0pt 792.0pt;\r\n\tmargin:70.85pt 70.85pt 70.85pt 70.85pt;}\r\ndiv.WordSection1\r\n\t{page:WordSection1;}\r\n--></style>\n</head>\n<body lang=\"FR\" link=\"#467886\" style=\"word-wrap:break-word\" vlink=\"#96607D\">\n<div class=\"WordSection1\">\n<p class=\"MsoNormal\">Bonjour Benoit,<o:p></o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<p class=\"MsoNormal\">Voici le BAT pour l\u2019email NE Photoweb <o:p></o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<p class=\"MsoNormal\">Belle journ\u00e9e <o:p></o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<p class=\"MsoNormal\"><b><a data-index=\"1\" href=\"https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqrTJBsmCulFQ%2BZ200mv9SeR8Mx2J8KsqYP%2B4GRZH3kHQ%3D%3D\" target=\"_blank\">https://m12.news.laredoute.fr/nl/jsp/m.jsp?c=%40qUCD8eyZQXuTPqgBna3aO7cWdC8C0avW6Td2cL8DTXqrTJBsmCulFQ%2BZ200mv9SeR8Mx2J8KsqYP%2B4GRZH3kHQ%3D%3D</a></b><o:p></o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<p class=\"MsoNormal\"><o:p>\u00a0</o:p></p>\n<div>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"MsoNormalTable\" style=\"width:430.0pt;border-collapse:collapse\" width=\"573\">\n<tbody>\n<tr>\n<td style=\"padding:0cm 11.25pt 0cm 0cm\">\n<p class=\"MsoNormal\"><span style=\"font-size:13.5pt;font-family:Poppins;color:black;mso-fareast-language:FR\"><img border=\"0\" height=\"100\" id=\"Image_x0020_1\" src=\"cid:image001.gif@01DC78C9.344DDD30\" style=\"width:1.0416in;height:1.0416in\" width=\"100\"/></span><span style=\"mso-ligatures:none;mso-fareast-language:FR\"><o:p></o:p></span></p>\n</td>\n<td style=\"padding:0cm 0cm 0cm 0cm\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"MsoNormalTable\" style=\"width:330.0pt;border-collapse:collapse\" width=\"440\">\n<tbody>\n<tr>\n<td style=\"padding:0cm 0cm 0cm 0cm\">\n<p class=\"MsoNormal\"><b><span style=\"font-size:10.5pt;font-family:Poppins;mso-ligatures:none;mso-fareast-language:FR\">Victoire Debarge</span></b><span style=\"mso-ligatures:none;mso-fareast-language:FR\"><o:p></o:p></span></p>\n</td>\n</tr>\n<tr>\n<td style=\"padding:0cm 0cm 0cm 0cm\">\n<div>\n<p class=\"MsoNormal\"><span style=\"color:black;mso-ligatures:none;mso-fareast-language:FR\">Account Manager Retail Media</span><span style=\"color:black;mso-ligatures:none;mso-fareast-language:FR\"><o:p></o:p></span></p>\n</div>\n</td>\n</tr>\n<tr>\n<td style=\"padding:0cm 0cm 0cm 0cm\">\n<p class=\"MsoNormal\"><u><span style=\"color:blue;mso-ligatures:none;mso-fareast-language:FR\"><a data-index=\"2\" href=\"mailto:vdebarge@redoute.fr\"><span style=\"color:blue\">vdebarge</span></a></span></u><u><span style=\"font-size:10.5pt;font-family:Poppins;color:blue;mso-ligatures:none;mso-fareast-language:FR\"><a data-index=\"3\" href=\"mailto:vdebarge@redoute.fr\"><span style=\"color:blue\">@redoute.fr</span></a></span></u><span style=\"mso-ligatures:none;mso-fareast-language:FR\"><o:p></o:p></span></p>\n</td>\n</tr>\n<tr>\n<td style=\"padding:0cm 0cm 0cm 0cm\"></td>\n</tr>\n</tbody>\n</table>\n</td>\n</tr>\n</tbody>\n</table>\n<p class=\"MsoNormal\"><span style=\"mso-ligatures:none;mso-fareast-language:FR\">\u00a0<o:p></o:p></span></p>\n<p class=\"MsoNormal\"><span style=\"mso-ligatures:none;mso-fareast-language:FR\">\u00a0</span><o:p></o:p></p>\n</div>\n</div>\r\nLes informations contenues dans ce message ainsi que dans les pi\u00e8ces jointes sont strictement confidentielles et r\u00e9serv\u00e9es \u00e0 l'usage exclusif de ses destinataires. Si vous prenez connaissance de ce message sans en \u00eatre le (la) destinataire, vous \u00eates pri\u00e9(e)\r\n d'en aviser imm\u00e9diatement l'\u00e9metteur et de le d\u00e9truire sous toutes ses formes. Toute diffusion ou publication, totale ou partielle, est interdite sauf autorisation expresse de l'\u00e9metteur. Les meilleurs efforts sont faits pour maintenir cette transmission exempte\r\n de tout virus mais l'int\u00e9grit\u00e9 de ce message n'est pas assur\u00e9e sur Internet : il a pu \u00eatre alt\u00e9r\u00e9 ou falsifi\u00e9. Les points de vue ou avis \u00e9manent de son auteur et ne repr\u00e9sentent pas n\u00e9cessairement ceux de la Soci\u00e9t\u00e9. Son contenu ne peut engager la responsabilit\u00e9\r\n de La Redoute et de ses filiales. This message and any attachments are strictly confidential and intended solely for the addressees. If you have received this message in error please delete it and notify the sender immediately. Any dissemination or disclosure,\r\n either whole or partial, is prohibited except formal approval of the sender. Best efforts are made in order to keep this message free of virus, but integrity of this message is not guaranteed through the Internet : it could have been altered or falsified.\r\n The views or opinions presented here are solely of the author and do not necessarily represent those of the Enterprise. Its content cannot bind La Redoute and its subsidiaries.\r\n</body>\n</html>\n";
        const frame = document.getElementById('emailFrame');
        let linksHighlighted = false;
        let overlayElements = [];
        let lastHighlightedIdx = null;
        let spotlightTimeout = null;

        function init() {
            const doc = frame.contentDocument;
            doc.open();
            doc.write(content);
            doc.close();

            const style = doc.createElement('style');
            style.innerHTML = `
                :root {
                    --spotlight-dim: rgba(0, 0, 0, 0.6);
                    --spotlight-glow: #50FA7B;
                }
                [data-theme="dark"] {
                    /* In Dark Mode (Inverted), we want the dimming to be light so it inverts to dark */
                    --spotlight-dim: rgba(255, 255, 255, 0.7);
                    /* And we use the complement of green so it inverts back to green */
                    --spotlight-glow: #AF0584; 
                }
                body { margin: 0; font-family: sans-serif; background: #fff; position: relative; }
                .link-outline { 
                    outline: 2px solid #8BE9FD !important; /* Cyan */
                    outline-offset: 1px !important;
                    transition: outline 0.2s ease;
                }
                .link-highlight-pulse {
                    animation: link-pulse 2s infinite;
                }
                @keyframes link-pulse {
                    0% { outline-color: #8BE9FD; outline-width: 2px; }
                    50% { outline-color: #BD93F9; outline-width: 4px; outline-offset: 3px; }
                    100% { outline-color: #8BE9FD; outline-width: 2px; }
                }
                .link-flash-spotlight {
                    position: relative !important;
                    z-index: 2147483647 !important;
                    outline: 8px solid var(--spotlight-glow) !important;
                    outline-offset: 4px !important;
                    box-shadow: 0 0 0 10000px var(--spotlight-dim), 0 0 40px var(--spotlight-glow) !important;
                    background-color: rgba(255, 255, 255, 1) !important;
                    color: #282a36 !important;
                }
            `;
            doc.head.appendChild(style);

            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') applyTheme('dark');
        }

        function setMode(mode) {
            const frameEl = document.getElementById('deviceFrame');
            const iframeEl = document.getElementById('emailFrame');

            document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.device-btn[onclick*="${mode}"]`);
            if (btn) btn.classList.add('active');

            // Remove/add scrollbar class
            if (mode === 'mobile') {
                frameEl.style.maxWidth = '375px';
                iframeEl.classList.add('no-scrollbar');
            } else if (mode === 'tablet') {
                frameEl.style.maxWidth = '600px';
                iframeEl.classList.add('no-scrollbar');
            } else {
                frameEl.style.maxWidth = '800px';
                iframeEl.classList.remove('no-scrollbar');
            }

            // Update overlays if visible
            if (linksHighlighted) {
                setTimeout(updateOverlays, 150);
            }
        }

        function highlightLink(idx) {
            const doc = frame.contentDocument;
            const link = doc.querySelector(`[data-index="${idx}"]`);
            if (link) {
                // Toggle Logic: If clicking the same link again, remove highlight
                if (lastHighlightedIdx === idx) {
                    doc.querySelectorAll('.link-flash-spotlight').forEach(el => el.classList.remove('link-flash-spotlight'));
                    if (!linksHighlighted) {
                        link.classList.remove('link-outline');
                    }
                    lastHighlightedIdx = null;
                    if (spotlightTimeout) clearTimeout(spotlightTimeout);
                    return;
                }

                lastHighlightedIdx = idx;

                // Ensure it's scrolled into view
                link.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove existing flash/spotlight from others
                doc.querySelectorAll('.link-flash-spotlight').forEach(el => el.classList.remove('link-flash-spotlight'));

                // Add spotlight class (this dims the rest of the iframe via large box-shadow)
                link.classList.add('link-flash-spotlight');

                // If Show Links is off, temporarily show this one's overlay/outline
                const wasHighlighted = linksHighlighted;
                if (!wasHighlighted) {
                    link.classList.add('link-outline');
                }

                if (spotlightTimeout) clearTimeout(spotlightTimeout);
                spotlightTimeout = setTimeout(() => {
                    link.classList.remove('link-flash-spotlight');
                    if (!wasHighlighted) {
                        link.classList.remove('link-outline');
                    }
                    if (lastHighlightedIdx === idx) lastHighlightedIdx = null;
                }, 4000); // 4 seconds spotlight
            }
        }

        function toggleHighlightLinks() {
            linksHighlighted = !linksHighlighted;
            const btn = document.getElementById('highlightBtnText');
            btn.textContent = linksHighlighted ? 'Hide Links' : 'Show Links';

            if (linksHighlighted) {
                createOverlays();
            } else {
                removeOverlays();
            }
        }

        function createOverlays() {
            removeOverlays();
            const doc = frame.contentDocument;
            const links = doc.querySelectorAll('[data-index]');
            const container = document.getElementById('linkOverlays');
            const frameRect = frame.getBoundingClientRect();

            links.forEach(link => {
                const idx = link.getAttribute('data-index');
                let rect = link.getBoundingClientRect();

                // Advanced Dimension Check: If element is "empty" or "inline-collapsed", check children or use parent
                if (rect.width <= 2 || rect.height <= 2) {
                    const children = link.querySelectorAll('img, table, div, span, p');
                    let found = false;
                    for (let child of children) {
                        const childRect = child.getBoundingClientRect();
                        if (childRect.width > 2 && childRect.height > 2) {
                            rect = childRect;
                            found = true;
                            break;
                        }
                    }
                    // If still no size, it might be a text-only link that is display: inline
                    // Try to get a range client rect if possible
                    if (!found) {
                        try {
                            const range = doc.createRange();
                            range.selectNodeContents(link);
                            const rangeRect = range.getBoundingClientRect();
                            if (rangeRect.width > 0) {
                                rect = rangeRect;
                            }
                        } catch (e) {
                            console.warn("Could not calculate range rect for link", idx);
                        }
                    }
                }

                // Final safety skip
                if (rect.width === 0 || rect.height === 0) return;

                // Clipping Logic: Only show badge if link is at least partially visible in iframe viewport
                // rect is relative to iframe viewport
                const iframeHeight = frame.clientHeight;
                const iframeWidth = frame.clientWidth;

                // If the link is fully out of view, skip it
                if (rect.bottom < 0 || rect.top > iframeHeight || rect.right < 0 || rect.left > iframeWidth) {
                    return;
                }

                // Create overlay badge
                const badge = document.createElement('div');
                badge.className = 'link-overlay-badge';
                badge.textContent = idx;

                // Position badge: top-right calculation relative to main window
                let badgeX, badgeY;
                if (rect.width < 15) {
                    badgeX = frameRect.left + rect.left + (rect.width / 2) - 10;
                    badgeY = frameRect.top + rect.top - 20;
                } else {
                    badgeX = frameRect.left + rect.left + rect.width - 6;
                    badgeY = frameRect.top + rect.top - 12;
                }

                // Ensure the badge itself is clipped by the frame boundaries
                // (e.g. don't let it overlap the header if the link is at the very top edge)
                if (badgeY < frameRect.top) {
                    // If the link is partially visible at top but badge would be outside,
                    // we can either hide it or stick it to the edge. Let's hide for clean look.
                    return;
                }
                if (badgeY > frameRect.bottom - 20) {
                    return;
                }

                badge.style.cssText = `
                    position: fixed;
                    left: ${badgeX}px;
                    top: ${badgeY}px;
                    background: #BD93F9; /* Purple for badges */
                    color: #fff;
                    font-size: 11px;
                    font-weight: 800;
                    padding: 0px 6px;
                    min-width: 20px;
                    height: 20px;
                    line-height: 20px;
                    border-radius: 10px;
                    font-family: 'Inter', sans-serif;
                    z-index: 1000;
                    box-shadow: 0 3px 6px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,255,255,0.8);
                    text-align: center;
                    border: none;
                    pointer-events: none;
                    opacity: 1;
                    transition: transform 0.2s ease;
                `;
                container.appendChild(badge);
                overlayElements.push(badge);

                // Add highlight to link in iframe
                link.classList.add('link-outline');
                link.classList.add('link-highlight-pulse');
            });
        }

        function removeOverlays() {
            const container = document.getElementById('linkOverlays');
            container.innerHTML = '';
            overlayElements = [];

            // Remove outlines from iframe links
            const doc = frame.contentDocument;
            if (doc) {
                const links = doc.querySelectorAll('[data-index]');
                links.forEach(link => {
                    link.classList.remove('link-outline');
                    link.classList.remove('link-highlight-pulse');
                    link.classList.remove('link-flash-spotlight');
                });
            }
        }

        function updateOverlays() {
            if (linksHighlighted) {
                createOverlays();
            }
        }

        // Update overlays logic
        frame.addEventListener('load', () => {
            frame.contentWindow.addEventListener('scroll', () => {
                if (linksHighlighted) updateOverlays();
            });
            frame.contentWindow.addEventListener('resize', () => {
                if (linksHighlighted) updateOverlays();
            });
        });

        function openHtmlModal() {
            const modal = document.getElementById('htmlModal');
            const codeEl = document.getElementById('htmlSourceCode');
            codeEl.textContent = content;
            modal.classList.add('active');
        }

        function closeHtmlModal() {
            document.getElementById('htmlModal').classList.remove('active');
        }

        function copyAllHtml() {
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        function copyLink(btn, url) {
            navigator.clipboard.writeText(url).then(() => {
                const originalHtml = btn.innerHTML;
                // Temporarily show checkmark
                btn.innerHTML = '<span style="color: var(--accent-green); font-weight: bold;">✓</span>';
                btn.classList.add('copy-success');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('copy-success');
                }, 1500);
            });
        }

        async function runAudit(btn, url) {
            // Find parent elements
            const cardBody = btn.closest('.card-v2-body');
            const logContainer = cardBody.querySelector('.audit-log-container');
            const timeline = logContainer.querySelector('.audit-timeline');
            const statusText = logContainer.querySelector('.audit-status-text');

            // Reset UI
            logContainer.classList.add('active');
            timeline.innerHTML = '';
            statusText.innerHTML = 'Initiating Audit...';
            statusText.className = 'audit-status-text text-yellow';

            // Allow animation
            await new Promise(r => setTimeout(r, 300));

            try {
                // Determine mock behavior based on URL patterns
                const isError = url.includes('error') || url.includes('404');
                const isTracking = url.includes('tracking') || url.includes('click');

                // --- Step 1: Initial Request ---
                timeline.innerHTML += `<div class="audit-step"><strong>GET</strong> ${url}</div>`;
                await new Promise(r => setTimeout(r, 600)); // Network delay

                if (isTracking) {
                    // --- Step 2: Redirection (Mock) ---
                    // Example: Tracking service -> Analytics Gateway -> Final URL
                    statusText.innerHTML = 'Following redirects...';

                    // Decode URL parts to look like real params but show FULL URL
                    const encodedTarget = encodeURIComponent(url);

                    timeline.innerHTML += `<div class="audit-step"><strong>302</strong> &rarr; https://analytics.wrapper.com/redirect?target=${encodedTarget}&ts=123456789</div>`;
                    await new Promise(r => setTimeout(r, 500));

                    timeline.innerHTML += `<div class="audit-step"><strong>301</strong> &rarr; https://campaign.landing.page/special-offer?utm_source=email&utm_medium=archive_tool&utm_campaign=winter_sale</div>`;
                    await new Promise(r => setTimeout(r, 500));

                    // Final Destination
                    if (isError) {
                        timeline.innerHTML += `<div class="audit-step error"><strong>404</strong> NOT FOUND</div>`;
                        statusText.innerHTML = 'Broken Link Detected';
                        statusText.className = 'audit-status-text text-red';
                    } else {
                        timeline.innerHTML += `<div class="audit-step final"><strong>200 OK</strong> &bull; Final Destination Reached</div>`;
                        statusText.innerHTML = 'Verification Complete';
                        statusText.className = 'audit-status-text text-green';
                    }
                } else if (isError) {
                    // Direct Error
                    timeline.innerHTML += `<div class="audit-step error"><strong>404</strong> NOT FOUND</div>`;
                    statusText.innerHTML = 'Broken Link';
                    statusText.className = 'audit-status-text text-red';
                } else {
                    // Direct Success
                    timeline.innerHTML += `<div class="audit-step final"><strong>200 OK</strong> &bull; Link validated successfully</div>`;
                    statusText.innerHTML = 'Verification Complete';
                    statusText.className = 'audit-status-text text-green';
                }

                // Visual feedback on button
                btn.style.color = isError ? 'var(--accent-red)' : 'var(--accent-green)';

            } catch (e) {
                statusText.innerHTML = 'Connection Error';
                statusText.className = 'audit-status-text text-red';
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('htmlModal');
                if (modal.classList.contains('active')) closeHtmlModal();
            }
            if (e.key === '1') setMode('mobile');
            if (e.key === '2') setMode('tablet');
            if (e.key === '3') setMode('desktop');
            if (e.key === 't' || e.key === 'T') toggleTheme();
            if (e.key === 'h' || e.key === 'H') toggleHighlightLinks();
            if (e.key === 'v' || e.key === 'V') openHtmlModal();

            // Scroll iframe with arrows
            if (e.key === 'ArrowDown') frame.contentWindow.scrollBy(0, 150);
            if (e.key === 'ArrowUp') frame.contentWindow.scrollBy(0, -150);
        });

        init();
    </script>
</body>

</html>