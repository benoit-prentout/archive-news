<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="viewer-layout">
        <!-- Main Content -->
        <div class="viewer-main">
            <!-- Header -->
            <header class="viewer-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h1
                        style="font-family: var(--font-header); font-size: 1rem; font-weight: 600; margin: 0; max-width: 500px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--accent-blue);">
                        {{ subject }}
                    </h1>
                </div>

                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="viewer-toolbar">
                        <button class="btn btn-secondary" onclick="toggleHighlightLinks()"
                            title="Highlight all links (H)">
                            <span id="highlightBtnText">Show Links</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openHtmlModal()" title="View HTML (V)">
                            View HTML
                        </button>
                    </div>

                    <span class="crm-badge" data-crm="{{ crm or 'Unknown' }}">{{ crm or 'Unknown' }}</span>

                    <div class="device-toggle hide-mobile">
                        <button class="device-btn" onclick="setMode('mobile')" title="Mobile (1)">Mobile</button>
                        <button class="device-btn" onclick="setMode('tablet')" title="Tablet (2)">Tablet</button>
                        <button class="device-btn active" onclick="setMode('desktop')"
                            title="Desktop (3)">Desktop</button>
                    </div>

                    <button class="btn-icon" id="theme-toggle" onclick="toggleTheme()" title="Toggle Theme (T)">
                        <svg class="icon icon-moon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg class="icon icon-sun" style="display:none;" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Email Content -->
            <div class="viewer-content">
                <div id="deviceFrame" data-mode="desktop"
                    style="width: 100%; max-width: 800px; height: 100%; transition: max-width 0.3s ease;">
                    <iframe id="emailFrame" class="email-frame"></iframe>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="viewer-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Metadata</span>
            </div>

            <div class="sidebar-content">
                <!-- General Info -->
                <div class="meta-section">
                    <div class="meta-section-title">General</div>
                    <div class="meta-row">
                        <span class="meta-key">Sender</span>
                        <span class="meta-val">{{ sender_name }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Subject</span>
                        <span class="meta-val"
                            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="{{ subject }}">{{ subject }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Preheader</span>
                        <span class="meta-val"
                            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="{{ preheader }}">{{ preheader }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Received</span>
                        <span class="meta-val">{{ email_date }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">CRM</span>
                        <span class="meta-val text-cyan">{{ crm or 'Unknown' }}</span>
                    </div>
                </div>

                <!-- Technical -->
                <div class="meta-section">
                    <div class="meta-section-title">Technical</div>
                    <div class="meta-row">
                        <span class="meta-key">Size</span>
                        <span class="meta-val">{{ (email_size / 1024)|round(1) }} KB</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Clipping Risk</span>
                        <span class="meta-val {% if email_size > 102000 %}text-orange{% else %}text-green{% endif %}">
                            {% if email_size > 102000 %}High{% else %}Low{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Tracking Pixels -->
                {% if detected_pixels %}
                <div class="meta-section">
                    <div class="meta-section-title">Tracking Pixels ({{ detected_pixels|length }})</div>
                    {% for pixel in detected_pixels %}
                    <div class="link-card" style="cursor: default;">
                        <div class="link-content">
                            <div class="link-text text-green">{{ pixel.status }}</div>
                            <div class="link-url">{{ pixel.url }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- All Links -->
                <div class="meta-section">
                    <div class="meta-section-title">Links ({{ links|length }})</div>
                    {% for link in links %}
                    <div class="link-card" onclick="highlightLink({{ link.index }})">
                        <span class="link-index">{{ link.index }}</span>
                        <div class="link-content">
                            <div class="link-text">{{ link.txt or '(no text)' }}</div>
                            <div class="link-url">{{ link.original_url }}</div>
                        </div>
                        <button class="link-copy-btn"
                            onclick="event.stopPropagation(); copyLink('{{ link.original_url | e }}')">Copy</button>
                    </div>
                    {% endfor %}
                </div>

                <!-- Footer -->
                <div class="meta-section"
                    style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                        © 2025 <a href="https://github.com/benoit-prentout" target="_blank"
                            style="color: var(--accent-blue); text-decoration: none;">Benoît Prentout</a>. All rights
                        reserved.
                    </p>
                </div>
            </div>
        </aside>
    </div>

    <!-- HTML Source Modal -->
    <div class="modal-overlay" id="htmlModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">HTML Source</span>
                <button class="modal-close" onclick="closeHtmlModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre class="code-block" id="htmlSourceCode"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="copyAllHtml()">Copy HTML</button>
            </div>
        </div>
    </div>

    <!-- Link overlays container -->
    <div id="linkOverlays" style="position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100;"></div>

    <script src="../assets/js/main.js"></script>
    <script>
        const content = {{ safe_html }};
        const frame = document.getElementById('emailFrame');
        let linksHighlighted = false;
        let overlayElements = [];

        function init() {
            const doc = frame.contentDocument;
            doc.open();
            doc.write(content);
            doc.close();

            const style = doc.createElement('style');
            style.innerHTML = `
                body { margin: 0; font-family: sans-serif; background: #fff; }
            `;
            doc.head.appendChild(style);

            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') applyTheme('dark');
        }

        function setMode(mode) {
            const frameEl = document.getElementById('deviceFrame');
            const iframeEl = document.getElementById('emailFrame');

            document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.device-btn[onclick*="${mode}"]`);
            if (btn) btn.classList.add('active');

            // Remove/add scrollbar class
            if (mode === 'mobile') {
                frameEl.style.maxWidth = '375px';
                iframeEl.classList.add('no-scrollbar');
            } else if (mode === 'tablet') {
                frameEl.style.maxWidth = '600px';
                iframeEl.classList.add('no-scrollbar');
            } else {
                frameEl.style.maxWidth = '800px';
                iframeEl.classList.remove('no-scrollbar');
            }

            // Update overlays if visible
            if (linksHighlighted) {
                setTimeout(updateOverlays, 100);
            }
        }

        function highlightLink(idx) {
            const doc = frame.contentDocument;
            const link = doc.querySelector(`[data-index="${idx}"]`);
            if (link) {
                link.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Flash highlight
                link.style.outline = '3px solid #50FA7B';
                link.style.outlineOffset = '2px';
                link.style.backgroundColor = 'rgba(80, 250, 123, 0.2)';

                setTimeout(() => {
                    link.style.outline = '';
                    link.style.outlineOffset = '';
                    link.style.backgroundColor = '';
                }, 3000);
            }
        }

        function toggleHighlightLinks() {
            linksHighlighted = !linksHighlighted;
            const btn = document.getElementById('highlightBtnText');
            btn.textContent = linksHighlighted ? 'Hide Links' : 'Show Links';

            if (linksHighlighted) {
                createOverlays();
            } else {
                removeOverlays();
            }
        }

        function createOverlays() {
            removeOverlays();
            const doc = frame.contentDocument;
            const links = doc.querySelectorAll('[data-index]');
            const container = document.getElementById('linkOverlays');
            const frameRect = frame.getBoundingClientRect();
            const scrollTop = doc.documentElement.scrollTop || doc.body.scrollTop;
            const scrollLeft = doc.documentElement.scrollLeft || doc.body.scrollLeft;

            links.forEach(link => {
                const idx = link.getAttribute('data-index');
                const rect = link.getBoundingClientRect();

                // Create overlay badge
                const badge = document.createElement('div');
                badge.className = 'link-overlay-badge';
                badge.textContent = idx;
                badge.style.cssText = `
                    position: fixed;
                    left: ${frameRect.left + rect.left}px;
                    top: ${frameRect.top + rect.top - 10}px;
                    background: #BD93F9;
                    color: #fff;
                    font-size: 11px;
                    font-weight: bold;
                    padding: 2px 6px;
                    border-radius: 10px;
                    font-family: sans-serif;
                    z-index: 1000;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    min-width: 16px;
                    text-align: center;
                `;
                container.appendChild(badge);
                overlayElements.push(badge);

                // Add outline to link in iframe
                link.style.outline = '2px solid #BD93F9';
                link.style.outlineOffset = '1px';
            });
        }

        function removeOverlays() {
            const container = document.getElementById('linkOverlays');
            container.innerHTML = '';
            overlayElements = [];

            // Remove outlines from iframe links
            const doc = frame.contentDocument;
            if (doc) {
                const links = doc.querySelectorAll('[data-index]');
                links.forEach(link => {
                    link.style.outline = '';
                    link.style.outlineOffset = '';
                });
            }
        }

        function updateOverlays() {
            if (linksHighlighted) {
                createOverlays();
            }
        }

        // Update overlays on scroll
        frame.addEventListener('load', () => {
            frame.contentWindow.addEventListener('scroll', () => {
                if (linksHighlighted) updateOverlays();
            });
        });

        function openHtmlModal() {
            const modal = document.getElementById('htmlModal');
            const codeEl = document.getElementById('htmlSourceCode');
            codeEl.textContent = content;
            modal.classList.add('active');
        }

        function closeHtmlModal() {
            document.getElementById('htmlModal').classList.remove('active');
        }

        function copyAllHtml() {
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = '✓';
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Escape: close modal if open
            if (e.key === 'Escape') {
                const modal = document.getElementById('htmlModal');
                if (modal.classList.contains('active')) {
                    closeHtmlModal();
                }
            }
            // 1, 2, 3: device modes
            if (e.key === '1') setMode('mobile');
            if (e.key === '2') setMode('tablet');
            if (e.key === '3') setMode('desktop');
            // T: toggle theme
            if (e.key === 't' || e.key === 'T') toggleTheme();
            // H: toggle highlight links
            if (e.key === 'h' || e.key === 'H') toggleHighlightLinks();
            // V: view HTML
            if (e.key === 'v' || e.key === 'V') openHtmlModal();
            // Arrow keys for scrolling iframe
            if (e.key === 'ArrowDown') frame.contentWindow.scrollBy(0, 100);
            if (e.key === 'ArrowUp') frame.contentWindow.scrollBy(0, -100);
        });

        init();
    </script>
</body>

</html>