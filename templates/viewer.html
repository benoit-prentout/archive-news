<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="viewer-layout">
        <!-- Main Content -->
        <div class="viewer-main">
            <!-- Header -->
            <header class="viewer-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <a href="../index.html"
                        style="color: var(--text-muted); text-decoration: none; display: flex; align-items: center; gap: 6px;">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span>Back</span>
                    </a>
                    <h1
                        style="font-family: var(--font-header); font-size: 1rem; font-weight: 600; margin: 0; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ subject }}
                    </h1>
                </div>

                <div style="display: flex; align-items: center; gap: 12px;">
                    {% if crm %}
                    <span class="crm-badge" data-crm="{{ crm }}">{{ crm }}</span>
                    {% endif %}

                    <div class="device-toggle hide-mobile">
                        <button class="device-btn" onclick="setMode('mobile')">Mobile</button>
                        <button class="device-btn" onclick="setMode('tablet')">Tablet</button>
                        <button class="device-btn active" onclick="setMode('desktop')">Desktop</button>
                    </div>

                    <button class="btn-icon" id="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                        <svg class="icon icon-moon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg class="icon icon-sun" style="display:none;" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Email Content -->
            <div class="viewer-content">
                <div id="deviceFrame" data-mode="desktop"
                    style="width: 100%; max-width: 700px; height: 100%; transition: all 0.3s ease;">
                    <iframe id="emailFrame" class="email-frame"></iframe>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="viewer-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Metadata</span>
            </div>

            <div class="sidebar-content">
                <!-- General Info -->
                <div class="meta-section">
                    <div class="meta-section-title">General</div>
                    <div class="meta-row">
                        <span class="meta-key">Sender</span>
                        <span class="meta-val">{{ sender_name }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Received</span>
                        <span class="meta-val">{{ email_date }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Archived</span>
                        <span class="meta-val">{{ archiving_date }}</span>
                    </div>
                    {% if crm %}
                    <div class="meta-row">
                        <span class="meta-key">CRM</span>
                        <span class="meta-val text-cyan">{{ crm }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Technical -->
                <div class="meta-section">
                    <div class="meta-section-title">Technical</div>
                    <div class="meta-row">
                        <span class="meta-key">Size</span>
                        <span class="meta-val">{{ (email_size / 1024)|round(1) }} KB</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Read Time</span>
                        <span class="meta-val">{{ reading_time }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Clipping Risk</span>
                        <span class="meta-val {% if email_size > 102000 %}text-red{% else %}text-green{% endif %}">
                            {% if email_size > 102000 %}High{% else %}Low{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Quality Audit -->
                <div class="meta-section">
                    <div class="meta-section-title">Quality Audit</div>
                    <div class="meta-row">
                        <span class="meta-key">Subject Length</span>
                        <span
                            class="meta-val {% if audit.subject_check == 'Good' %}text-green{% else %}text-orange{% endif %}">
                            {{ audit.subject_check }}
                        </span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Unsubscribe</span>
                        <span class="meta-val {% if audit.unsubscribe_found %}text-green{% else %}text-red{% endif %}">
                            {% if audit.unsubscribe_found %}Found{% else %}Missing{% endif %}
                        </span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-key">Images w/o Alt</span>
                        <span
                            class="meta-val {% if audit.images_no_alt == 0 %}text-green{% else %}text-orange{% endif %}">
                            {{ audit.images_no_alt }}
                        </span>
                    </div>
                </div>

                <!-- Tracking Pixels -->
                {% if detected_pixels %}
                <div class="meta-section">
                    <div class="meta-section-title">Tracking Pixels ({{ detected_pixels|length }})</div>
                    {% for pixel in detected_pixels %}
                    <div class="link-card">
                        <div class="link-text text-cyan">{{ pixel.status }}</div>
                        <div class="link-url">{{ pixel.url }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Links -->
                <div class="meta-section">
                    <div class="meta-section-title">Links ({{ links|length }})</div>
                    {% for link in links[:10] %}
                    <div class="link-card" onclick="highlightLink({{ link.index }})">
                        <div class="link-text">{{ link.txt or '(no text)' }}</div>
                        <div class="link-url">{{ link.original_url }}</div>
                    </div>
                    {% endfor %}
                    {% if links|length > 10 %}
                    <div style="text-align: center; padding: 8px; color: var(--text-muted); font-size: 0.8rem;">
                        + {{ links|length - 10 }} more links
                    </div>
                    {% endif %}
                </div>
            </div>
        </aside>
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        const content = {{ safe_html }};
        const frame = document.getElementById('emailFrame');

        function init() {
            const doc = frame.contentDocument;
            doc.open();
            doc.write(content);
            doc.close();

            const style = doc.createElement('style');
            style.innerHTML = `
                body { margin: 0; font-family: sans-serif; background: #fff; }
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
            `;
            doc.head.appendChild(style);

            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') applyTheme('dark');
        }

        function setMode(mode) {
            const frameEl = document.getElementById('deviceFrame');

            document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'mobile') {
                frameEl.style.maxWidth = '375px';
            } else if (mode === 'tablet') {
                frameEl.style.maxWidth = '768px';
            } else {
                frameEl.style.maxWidth = '700px';
            }
        }

        function highlightLink(idx) {
            const doc = frame.contentDocument;
            const link = doc.querySelector(`[data-index="${idx}"]`);
            if (link) {
                link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                link.style.outline = '3px solid #BD93F9';
                link.style.outlineOffset = '2px';
                setTimeout(() => {
                    link.style.outline = '';
                    link.style.outlineOffset = '';
                }, 2000);
            }
        }

        init();
    </script>
</body>

</html>