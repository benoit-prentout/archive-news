name: Gemini Issue Responder

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  respond:
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Call Gemini 1.5 Pro API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # 1. Construction du JSON
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              contents: [{
                parts: [{
                  text: ("Tu es un expert Senior Developer. Analyse cette issue GitHub : " + $title + ".\n\nDescription :\n" + $body + "\n\n1. Analyse la cause potentielle (Front-end/CSS/Rendering).\n2. Propose une solution technique pr√©cise.\n3. Si pertinent, donne un exemple de code.")
                }]
              }]
            }' > payload.json

          # 2. Appel API vers GEMINI 1.5 PRO
          # CORRECTION : Utilisation du nom strict "gemini-1.5-pro" sans "latest"
          curl -s \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=$GEMINI_API_KEY" > response.json
          
          # 3. DEBUG : Afficher la r√©ponse brute (en cas de nouvelle erreur)
          echo "--- DEBUG: RAW API RESPONSE ---"
          cat response.json
          echo "-------------------------------"

          # 4. Extraction de la r√©ponse
          ANSWER=$(cat response.json | jq -r '.candidates[0].content.parts[0].text')
          
          # Gestion d'erreur
          if [ "$ANSWER" == "null" ]; then
            ERROR_MSG=$(cat response.json | jq -r '.error.message // "Erreur inconnue"')
            ANSWER="‚ùå **Erreur Gemini :** $ERROR_MSG"
          fi

          # 5. Sauvegarde environment
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "üß† **Analyse Gemini 1.5 Pro :**
          
          $AI_RESPONSE"
