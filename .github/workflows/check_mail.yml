name: Gemini Debugger

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  debug_and_respond:
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üîç STEP 1 - LIST AVAILABLE MODELS
        id: list_models
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo ">>> Interrogation de l'API pour conna√Ætre les mod√®les disponibles..."
          
          curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=$GEMINI_API_KEY" > models_list.json
          
          echo ">>> VOICI LA LISTE DES MOD√àLES DISPONIBLES POUR TA CL√â :"
          cat models_list.json
          echo ">>> FIN DE LA LISTE"

      - name: üß™ STEP 2 - TEST GENERATION (Gemini 1.5 Flash)
        id: test_gen
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Construction du JSON
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              contents: [{
                parts: [{
                  text: ("Analisis technique de l issue : " + $title + ". " + $body)
                }]
              }]
            }' > payload.json

          echo ">>> Envoi de la requ√™te au mod√®le 'models/gemini-1.5-flash'..."

          # On utilise le nom "models/gemini-1.5-flash" qui est souvent requis formellement
          curl -s \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" > response.json
          
          echo ">>> R√âPONSE BRUTE DE L'API :"
          cat response.json
          
          # Extraction propre
          ANSWER=$(cat response.json | jq -r '.candidates[0].content.parts[0].text')
          
          # Gestion d'erreur pour le commentaire
          if [ "$ANSWER" == "null" ]; then
            ERROR_MSG=$(cat response.json | jq -r '.error.message // "Erreur inconnue"')
            ANSWER="‚ùå **ECHEC DEBUG** : $ERROR_MSG"
          fi
          
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Result
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "üõ†Ô∏è **R√©sultat du Debug :**
          
          $AI_RESPONSE"
